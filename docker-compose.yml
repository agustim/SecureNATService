services:
  nginx:
    image: nginx:latest
    volumes:
      - ./html:/usr/share/nginx/html
    depends_on:
      - tor
      - cloudflared
    networks:
      - tor_network

  tor:
    image: alpine:latest
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - URL_SERVICE=host.docker.internal:3000
    command: sh -c "apk update && apk add tor && chmod 700 /var/lib/tor/hidden_service && (cat /var/lib/tor/hidden_service/hostname || echo 'Hostname not available.') && tor -f /etc/tor/torrc"
    volumes:
      - ./tor-config:/etc/tor:rw
      - ./hidden_service:/var/lib/tor/hidden_service:rw
    networks:
      - tor_network

  cloudflared:
    image: cloudflare/cloudflared:latest
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TUNNEL_ORIGIN_CERT=/etc/cloudflared/cert.pem
      - TUNNEL_CRED_FILE=/etc/cloudflared/0fd36de5-95dc-401b-97c3-fbe349af6e3a.json
      - TUNNEL_URL=http://host.docker.internal:3000
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared:rw
    networks:
      - tor_network

networks:
  tor_network: